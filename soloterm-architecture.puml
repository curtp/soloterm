@startuml SoloTerm Architecture

!define DOMAIN_COLOR #E8F5E9
!define UI_COLOR #E3F2FD
!define SHARED_COLOR #FFF9C4
!define DB_COLOR #FCE4EC

skinparam packageStyle rectangle
skinparam linetype ortho

' ==================== DOMAIN LAYER ====================
package "domain/game" <<Rectangle>> DOMAIN_COLOR {
    class Game {
        + Id: int64
        + Name: string
        + Description: *string
        + CreatedAt: time.Time
        + UpdatedAt: time.Time
        --
        + NewGame(name: string): (*Game, error)
        + Validate(): *Validator
    }

    class GameRepository {
        - db: *sqlx.DB
        --
        + NewRepository(db: *sqlx.DB): *Repository
        + Save(game: *Game): error
        + Delete(id: int64): (int64, error)
        + GetByID(id: int64): (*Game, error)
        + GetAll(): ([]*Game, error)
        - insert(game: *Game): error
        - update(game: *Game): error
    }

    class GameService {
        - repo: *GameRepository
        --
        + NewService(repo: *Repository): *Service
        + Save(game: *Game): (*Game, error)
        + Delete(id: int64): error
        + GetByID(id: int64): (*Game, error)
        + GetAll(): ([]*Game, error)
    }

    note right of Game
        Validation Rules:
        - Name: 1-50 chars (required)
        - Description: 3-100 chars (optional)
    end note
}

package "domain/log" <<Rectangle>> DOMAIN_COLOR {
    enum LogType {
        CHARACTER_ACTION
        ORACLE_QUESTION
        MECHANICS
    }

    class Log {
        + ID: int64
        + GameID: int64
        + LogType: LogType
        + Description: string
        + Narrative: string
        + Result: string
        + CreatedAt: time.Time
        + UpdatedAt: time.Time
        --
        + NewLog(game_id: int64): (*Log, error)
        + Validate(): *Validator
    }

    class Session {
        + GameID: int64
        + Date: string
        + LogCount: int
    }

    class LogRepository {
        - db: *sqlx.DB
        --
        + NewRepository(db: *sqlx.DB): *Repository
        + Save(log: *Log): error
        + Delete(id: int64): (int64, error)
        + DeleteAllForGame(game_id: int64): (int64, error)
        + GetByID(id: int64): (*Log, error)
        + GetAllForGame(game_id: int64): ([]*Log, error)
        + GetSessionsForGame(game_id: int64): ([]*Session, error)
        + GetLogsForSession(game_id: int64, session_date: string): ([]*Log, error)
        - insert(log: *Log): error
        - update(log: *Log): error
    }

    class LogService {
        - repo: *LogRepository
        --
        + NewService(repo: *Repository): *Service
        + Save(log: *Log): (*Log, error)
        + Delete(id: int64): error
        + GetByID(id: int64): (*Log, error)
        + GetAllForGame(gameID: int64): ([]*Log, error)
        + GetSessionsForGame(gameID: int64): ([]*Session, error)
        + GetLogsForSession(gameID: int64, sessionDate: string): ([]*Log, error)
    }

    note right of Session
        Virtual grouping of logs by date
        Used for organizing logs in UI tree
    end note
}

' ==================== UI LAYER ====================
package "ui" <<Rectangle>> UI_COLOR {
    class App {
        + *tview.Application
        --
        - db: *sqlx.DB
        - gameService: *game.Service
        - logService: *log.Service
        - gameHandler: *GameHandler
        - logHandler: *LogHandler
        --
        - selectedGame: *Game
        - selectedLog: *Log
        --
        - rootFlex: *tview.Flex
        - mainFlex: *tview.Flex
        - pages: *tview.Pages
        - notificationFlex: *tview.Flex
        --
        - gameTree: *tview.TreeView
        - logView: *tview.TextView
        - helpModal: *tview.Modal
        - confirmModal: *ConfirmationModal
        - footer: *tview.TextView
        - gameModal: *tview.Flex
        - gameForm: *GameForm
        - logModal: *tview.Flex
        - logForm: *LogForm
        - notification: *Notification
        --
        + NewApp(db: *sqlx.DB): *App
        + Run(): error
        - setupUI()
        - setupKeyBindings()
        - refreshGameTree()
        - loadLogsForSelectedGameEntry()
        - showGameModal()
        - showLogModal()
        - showEditGameModal(game: *Game)
        - togglePane(pane: tview.Primitive)
        - handleGameSave()
        - handleGameCancel()
        - handleGameDelete()
        - handleLogSave()
        - handleLogCancel()
        - handleLogDelete()
        - handleGameEdit(gameID: int64)
        - handleLogEdit(logID: int64)
        - loadLogsForGame(gameID: int64)
        - loadLogsForSession(gameID: int64, sessionDate: string)
        - displayLogs(logs: []*Log)
    }

    class GameHandler {
        - app: *App
        --
        + NewGameHandler(app: *App): *GameHandler
        + HandleSave()
        + HandleCancel()
        + HandleEdit()
        + HandleDelete()
    }

    class LogHandler {
        - app: *App
        --
        + NewLogHandler(app: *App): *LogHandler
        + HandleSave()
        + HandleCancel()
        + HandleEdit()
        + HandleDelete()
        + LoadLogsForGame(gameID: int64)
        + LoadLogsForSession(gameID: int64, sessionDate: string)
        + DisplayLogs(logs: []*Log)
    }

    interface ValidatableForm {
        + SetFieldError(field: string, message: string)
        + SetFieldErrors(errors: map[string]string)
        + UpdateFieldLabels()
        + ClearFieldErrors()
    }

    class GameForm {
        + *tview.Form
        --
        - gameID: *int64
        - nameField: *tview.InputField
        - descriptionField: *tview.TextArea
        - errorMessage: *tview.TextView
        - fieldErrors: map[string]string
        - onSave: func()
        - onCancel: func()
        - onDelete: func()
        --
        + NewGameForm(): *GameForm
        + BuildDomain(): *Game
        + GetValues(): (id: *int64, name: string, description: string)
        + SetupHandlers(onSave: func(), onCancel: func(), onDelete: func())
        + PopulateForEdit(game: *Game)
        + Reset()
        + SetFieldError(field: string, message: string)
        + SetFieldErrors(errors: map[string]string)
        + UpdateFieldLabels()
        + ClearFieldErrors()
        - setupForm()
    }

    class LogForm {
        + *tview.Form
        --
        - id: *int64
        - gameID: int64
        - logTypeField: *tview.DropDown
        - resultField: *tview.InputField
        - narrativeField: *tview.TextArea
        - descriptionField: *tview.InputField
        - errorMessage: *tview.TextView
        - fieldErrors: map[string]string
        - onSave: func()
        - onCancel: func()
        - onDelete: func()
        --
        + NewLogForm(): *LogForm
        + BuildDomain(): *Log
        + GetValues(): (id: *int64, logType: LogType, description: string, result: string, narrative: string)
        + SetupHandlers(onSave: func(), onCancel: func(), onDelete: func())
        + PopulateForEdit(log: *Log)
        + Reset(gameID: int64)
        + SetFieldError(field: string, message: string)
        + SetFieldErrors(errors: map[string]string)
        + UpdateFieldLabels()
        + ClearFieldErrors()
        - setupForm()
    }

    class ConfirmationModal {
        + *tview.Modal
        --
        - message: string
        - onConfirm: func()
        - onCancel: func()
        --
        + NewConfirmationModal(message: string, onConfirm: func(), onCancel: func()): *ConfirmationModal
        + Show(pages: *tview.Pages)
        + Hide(pages: *tview.Pages)
    }

    enum NotificationType {
        INFO
        SUCCESS
        WARNING
        ERROR
    }

    class Notification {
        + *tview.TextView
        --
        - notificationType: NotificationType
        - duration: time.Duration
        - hideFunc: func()
        --
        + NewNotification(hideFunc: func()): *Notification
        + ShowInfo(message: string)
        + ShowSuccess(message: string)
        + ShowWarning(message: string)
        + ShowError(message: string)
        - show(message: string, notificationType: NotificationType)
        - hide()
    }

    note right of App
        Main TUI Application
        Keyboard Shortcuts:
        - F1: Help
        - Ctrl+G: New Game
        - Ctrl+L: New Log Entry
        - Ctrl+E: Edit Selected
        - Ctrl+B: Toggle Sidebar
        - Ctrl+C: Quit
    end note
}

' ==================== SHARED LAYER ====================
package "shared/validation" <<Rectangle>> SHARED_COLOR {
    class Validator {
        + Errors: []ValidationError
        --
        + NewValidator(): *Validator
        + Check(identifier: string, checkResult: bool, errMsg: string, args: ...any)
        + IsInError(identifier: string): bool
        + HasErrors(): bool
        + GetError(identifier: string): *ValidationError
        + GetErrorMessagesFor(identifier: string): string
        + GetAllErrorMessages(): string
    }

    class ValidationFieldError {
        + Field: string
        + Messages: []string
        --
        + FormattedErrorMessage(): string
    }
}

' ==================== DATABASE LAYER ====================
package "database" <<Rectangle>> DB_COLOR {
    class Database {
        {static} + Setup(): (*sqlx.DB, error)
        {static} + Connect(): (*sqlx.DB, error)
        {static} + ConnectWithPath(dbPath: string): (*sqlx.DB, error)
        {static} + RegisterMigration(fn: MigrationFunc)
        {static} + AddColumn(db: *sqlx.DB, tableName: string, column: string, columnType: string, notnull: bool, defaultValue: *string): error
        {static} - columnExists(db: *sqlx.DB, table: string, column: string): (bool, error)
    }

    interface MigrationFunc {
        + (db: *sqlx.DB): error
    }
}

' ==================== EXTERNAL DEPENDENCIES ====================
package "External Libraries" <<Rectangle>> #F5F5F5 {
    class "sqlx.DB" as sqlxDB {
        Database connection pool
    }

    class "tview" as tview {
        Terminal UI framework
    }
}

' ==================== RELATIONSHIPS ====================

' Domain relationships
Game "1" -- "0..*" Log : has
Log --> LogType : uses
LogRepository ..> Session : returns

' Repository dependencies
GameRepository --> sqlxDB : uses
LogRepository --> sqlxDB : uses
GameRepository ..> Game : manages
LogRepository ..> Log : manages

' Service dependencies
GameService --> GameRepository : uses
GameService ..> Game : creates
LogService --> LogRepository : uses
LogService ..> Log : creates
LogService ..> Session : returns

' UI dependencies
App *-- GameForm : contains
App *-- LogForm : contains
App *-- ConfirmationModal : contains
App *-- Notification : contains
App *-- GameHandler : contains
App *-- LogHandler : contains
App --> sqlxDB : uses
App --> GameService : uses
App --> LogService : uses
App --|> tview : extends

GameHandler --> App : accesses
LogHandler --> App : accesses
GameHandler ..> GameService : uses
LogHandler ..> LogService : uses

GameForm ..|> ValidatableForm : implements
GameForm --|> tview : extends
GameForm ..> Game : populates
LogForm ..|> ValidatableForm : implements
LogForm --|> tview : extends
LogForm ..> LogType : uses
LogForm ..> Log : populates

ConfirmationModal --|> tview : extends
Notification --|> tview : extends
Notification --> NotificationType : uses

' Validation relationships
Game ..> Validator : validates with
Log ..> Validator : validates with
Validator *-- ValidationFieldError : contains
ValidatableForm ..> ValidationFieldError : displays

' Database relationships
Database ..> sqlxDB : creates
Database ..> MigrationFunc : executes

' Main entry point (not shown in detail)
note as MainNote
    <b>main.go</b>
    1. database.Setup() → *sqlx.DB
    2. ui.NewApp(db) → *App
    3. app.Run() → event loop
end note

MainNote .. Database
MainNote .. App

@enduml
