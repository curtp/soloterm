@startuml SoloTerm Architecture

!define DOMAIN_COLOR #E8F5E9
!define UI_COLOR #E3F2FD
!define SHARED_COLOR #FFF9C4
!define DB_COLOR #FCE4EC

skinparam packageStyle rectangle
skinparam linetype ortho

' ==================== DOMAIN LAYER ====================
package "domain" <<Rectangle>> DOMAIN_COLOR {
    package "game" {
        class Game {
            + ID, Name, Description
            + CreatedAt, UpdatedAt
            --
            + Validate(): *Validator
        }

        class GameService {
            + Save, Delete, GetByID, GetAll
        }

        class GameRepository {
            + Save, Delete, GetByID, GetAll
        }
    }

    package "log" {
        enum LogType {
            CHARACTER_ACTION
            ORACLE_QUESTION
            MECHANICS
            STORY
        }

        class Log {
            + ID, GameID, LogType
            + Description, Narrative, Result
            + CreatedAt, UpdatedAt
            --
            + Validate(): *Validator
        }

        class Session {
            + GameID, Date, LogCount
        }

        class LogService {
            + Save, Delete, GetByID
            + GetSessionsForGame
            + GetLogsForSession
        }

        class LogRepository {
            + Save, Delete, GetByID
            + GetSessionsForGame
            + GetLogsForSession
        }
    }

    package "character" {
        class Character {
            + ID, Name, System, Role, Species
            + CreatedAt, UpdatedAt
            --
            + Validate(): *Validator
        }

        class Attribute {
            + ID, CharacterID, Name, Value
            + Group, PositionInGroup
            + CreatedAt, UpdatedAt
            --
            + Validate(): *Validator
        }

        class CharacterService {
            + Save, Delete, GetByID, GetAll
            + Duplicate
            + SaveAttribute, DeleteAttribute
            + GetAttributesForCharacter
        }

        class CharacterRepository {
            + Save, Delete, GetByID, GetAll
            + Duplicate
            + SaveAttribute, DeleteAttribute
            + GetAttributesForCharacter
        }
    }

    note as DomainNote
        <b>Domain Layer Pattern</b>
        Each domain follows:
        Entity -> Service -> Repository

        - Entities own validation rules
        - Services coordinate business logic
        - Repositories handle persistence
    end note
}

' ==================== UI LAYER ====================
package "ui" <<Rectangle>> UI_COLOR {

    class App {
        <b>Central Orchestrator</b>
        --
        - gameService, logService, charService
        - gameView, logView, characterView
        - selectedGame: *Game
        --
        <b>UI Components</b>
        - pages, gameTree, charTree
        - logTextView, attributeTable
        - notification, confirmModal
        --
        + HandleEvent(event Event)
        - handle{Domain}{Action}() methods
    }

    together {
        class GameView {
            - app: *App
            - helper: *GameViewHelper
            --
            + Setup(), Refresh()
            + HandleSave(), HandleCancel()
            + HandleDelete(), ConfirmDelete()
            + ShowNewModal(), ShowEditModal()
        }

        class LogView {
            - app: *App
            - helper: *LogViewHelper
            --
            + Setup(), Refresh()
            + HandleSave(), HandleCancel()
            + HandleDelete(), ConfirmDelete()
            + ShowNewModal(), ShowEditModal()
        }

        class CharacterView {
            - app: *App
            - helper: *CharacterViewHelper
            + ReturnFocus: tview.Primitive
            --
            + Setup(), RefreshTree(), RefreshDisplay()
            + HandleSave(), HandleCancel()
            + HandleDelete(), ConfirmDelete()
            + HandleDuplicate(), ConfirmDuplicate()
            + Attribute CRUD methods
        }
    }

    together {
        class GameViewHelper {
            - gameService, logService
            --
            + LoadAllGames(): []*GameWithSessions
        }

        class LogViewHelper {
            - logService
            --
            + LoadLogsForGame()
            + LoadLogsForSession()
            + FormatLogDisplay()
        }

        class CharacterViewHelper {
            - charService
            --
            + LoadAllCharacters()
            + LoadAttributesForCharacter()
            + GroupCharactersBySystem()
        }
    }

    package "Events" {
        interface Event {
            + Action(): UserAction
        }

        class BaseEvent {
            - action: UserAction
        }

        note as EventTypes
            <b>Event Types (per domain)</b>
            - {Domain}SavedEvent
            - {Domain}DeletedEvent
            - {Domain}DeleteConfirmEvent
            - {Domain}DeleteFailedEvent
            - {Domain}CancelledEvent
            - {Domain}ShowNewEvent
            - {Domain}ShowEditEvent
        end note
    }

    package "Forms" {
        class GameForm
        class LogForm
        class CharacterForm
        class AttributeForm

        interface DataForm {
            + BuildDomain(): Entity
            + PopulateForEdit(entity)
            + Reset()
            + SetFieldErrors()
            + ClearFieldErrors()
        }
    }

    class ConfirmationModal {
        + Configure(message, onConfirm, onCancel)
    }

    class Notification {
        + ShowInfo, ShowSuccess
        + ShowWarning, ShowError
    }

    note as UIFlowNote
        <b>Event-Driven UI Flow</b>

        1. User interacts with UI component
        2. View method handles interaction
        3. View calls Service for business logic
        4. View dispatches typed Event
        5. App.HandleEvent() routes to handler
        6. Handler updates UI state

        Example:
        KeyPress -> GameView.HandleSave()
        -> gameService.Save()
        -> HandleEvent(GameSavedEvent)
        -> handleGameSaved()
        -> refresh, notify, focus
    end note

    note as ViewNote
        <b>View Responsibilities</b>
        - Setup UI components & key bindings
        - Handle user actions (save, delete, etc.)
        - Call services for business logic
        - Dispatch events to App

        <b>ViewHelper Responsibilities</b>
        - Load and transform data
        - Format data for display
        - No UI manipulation
    end note
}

' ==================== SHARED LAYER ====================
package "shared" <<Rectangle>> SHARED_COLOR {
    class Validator {
        + Errors: map[string][]string
        --
        + Check(field, condition, message)
        + HasErrors(): bool
        + Error(): string
    }

    class "ui/DataForm" as SharedDataForm {
        Base form functionality
        for validation integration
    }
}

' ==================== DATABASE LAYER ====================
package "database" <<Rectangle>> DB_COLOR {
    class DBStore {
        + *sqlx.DB
        --
        + Setup(): *DBStore
        + RegisterMigration()
    }

    note as DBNote
        SQLite with:
        - WAL mode
        - Foreign keys enabled
        - Cascading deletes
    end note
}

' ==================== EXTERNAL ====================
package "External" <<Rectangle>> #F5F5F5 {
    class "tview/tcell" as tview {
        Terminal UI framework
    }

    class "sqlx" as sqlx {
        SQL extensions for Go
    }

    class "modernc/sqlite" as sqlite {
        Pure Go SQLite driver
    }
}

' ==================== RELATIONSHIPS ====================

' Domain internal
Game "1" -- "0..*" Log : has
Character "1" -- "0..*" Attribute : has
Log --> LogType

GameService --> GameRepository
LogService --> LogRepository
CharacterService --> CharacterRepository

GameRepository ..> Game
LogRepository ..> Log
LogRepository ..> Session
CharacterRepository ..> Character
CharacterRepository ..> Attribute

' UI Layer
App *-- GameView
App *-- LogView
App *-- CharacterView
App *-- Notification
App *-- ConfirmationModal

GameView --> GameViewHelper
LogView --> LogViewHelper
CharacterView --> CharacterViewHelper

GameView ..> Event : dispatches
LogView ..> Event : dispatches
CharacterView ..> Event : dispatches

App ..> Event : handles

GameViewHelper --> GameService
GameViewHelper --> LogService
LogViewHelper --> LogService
CharacterViewHelper --> CharacterService

GameForm ..|> DataForm
LogForm ..|> DataForm
CharacterForm ..|> DataForm
AttributeForm ..|> DataForm

BaseEvent ..|> Event

' Cross-layer
App --> GameService
App --> LogService
App --> CharacterService
App --> DBStore

Game ..> Validator
Log ..> Validator
Character ..> Validator
Attribute ..> Validator

DBStore --> sqlx
App --> tview

' Entry point
note as MainNote
    <b>main.go</b>
    1. database.Setup() -> *DBStore
    2. ui.NewApp(db) -> *App
    3. app.EnableMouse()
    4. app.Run() -> event loop
end note

MainNote .. App

@enduml
