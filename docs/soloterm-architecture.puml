@startuml SoloTerm Architecture

!define DOMAIN_COLOR #E8F5E9
!define UI_COLOR #E3F2FD
!define SHARED_COLOR #FFF9C4
!define DB_COLOR #FCE4EC

skinparam packageStyle rectangle
skinparam linetype ortho

' ==================== DOMAIN LAYER ====================
package "domain" <<Rectangle>> DOMAIN_COLOR {
    package "game" {
        class Game {
            + Validate(): *Validator
        }

        class GameService {
            + Save, Delete, GetByID, GetAll
        }

        class GameRepository {
            + Save, Delete, GetByID, GetAll
        }
    }

    package "session" {
        class Session {
            + IsNew(): bool
            + Validate(): *Validator
        }

        class SessionService {
            + Save, Delete, GetByID
            + GetAllForGame
        }

        class SessionRepository {
            + Save, Delete, GetByID
            + GetAllForGame
            + GetAllContentForGame
            + DeleteAllForGame
        }
    }

    package "tag" {
        class TagType {
            + Label, Template
        }

        class TagService {
            + LoadTagsForGame()
            - extractRecentTags()
        }
    }

    package "character" {
        class Character {
            + Validate(): *Validator
        }

        class Attribute {
            + Validate(): *Validator
        }

        class CharacterService {
            + Save, Delete, GetByID, GetAll
            + Duplicate
        }

        class CharacterRepository {
            + Save, Delete, GetByID, GetAll
        }

        class AttributeService {
            + Save, Delete, GetByID
            + GetForCharacter
        }

        class AttributeRepository {
            + Save, Delete, GetByID
            + GetForCharacter
        }
    }

    note as DomainNote
        <b>Domain Layer Pattern</b>
        Each domain follows:
        Entity -> Service -> Repository

        - Entities own validation rules
        - Services coordinate business logic
        - Repositories handle persistence
        - Tag domain has no persistence
          (config + session content extraction)
    end note
}

' ==================== UI LAYER ====================
package "ui" <<Rectangle>> UI_COLOR {

    class App {
        <b>Central Orchestrator</b>
        --
        - gameView, sessionView
        - characterView, attributeView
        - tagView
        --
        <b>UI Components</b>
        - pages, leftSidebar
        - notification, confirmModal
        - helpModal, aboutModal, footer
        --
        + HandleEvent(event Event)
        + isPageVisible(pageID): bool
    }

    together {
        class GameView {
            - gameService, sessionService
            - helper: *GameViewHelper
            --
            + Setup(), Refresh()
            + SelectGame(), SelectSession()
            + HandleSave(), HandleCancel()
            + HandleDelete(), ConfirmDelete()
        }

        class SessionView {
            - sessionService
            - TextArea, autosaveTicker
            - isDirty, isLoading
            --
            + Setup(), Refresh()
            + HandleSave(), HandleCancel()
            + HandleDelete(), ConfirmDelete()
            + Autosave()
        }

        class CharacterView {
            - charService
            - helper: *CharacterViewHelper
            --
            + Setup(), RefreshTree()
            + HandleSave(), HandleCancel()
            + HandleDelete(), ConfirmDelete()
            + HandleDuplicate(), ConfirmDuplicate()
        }

        class AttributeView {
            - attrService
            --
            + Setup(), LoadAndDisplay()
            + HandleSave(), HandleCancel()
            + HandleDelete(), ConfirmDelete()
        }

        class TagView {
            - tagService, config
            --
            + Setup(), LoadTags()
            + SelectTag()
        }
    }

    package "Events" {
        interface Event {
            + Action(): UserAction
        }

        class BaseEvent

        note as EventTypes
            <b>Event Types (per domain)</b>
            - {Domain}SavedEvent
            - {Domain}DeletedEvent
            - {Domain}DeleteConfirmEvent
            - {Domain}DeleteFailedEvent
            - {Domain}CancelledEvent
            - {Domain}ShowNewEvent
            - {Domain}ShowEditEvent
            --
            <b>Special Events</b>
            - TagSelectedEvent, TagShowEvent
            - ShowHelpEvent, CloseHelpEvent
            - CharacterDuplicatedEvent
        end note
    }

    package "Forms" {
        class GameForm
        class SessionForm
        class CharacterForm
        class AttributeForm

        interface DataForm {
            + BuildDomain(): Entity
            + PopulateForEdit(entity)
            + Reset()
            + SetFieldErrors()
            + ClearFieldErrors()
        }
    }

    class ConfirmationModal
    class HelpModal
    class Notification

    note as UIFlowNote
        <b>Event-Driven UI Flow</b>

        1. User interacts with UI component
        2. View method handles interaction
        3. View calls Service for business logic
        4. View dispatches typed Event
        5. App.HandleEvent() routes to handler
        6. Handler updates UI state

        Example:
        KeyPress -> GameView.HandleSave()
        -> gameService.Save()
        -> HandleEvent(GameSavedEvent)
        -> handleGameSaved()
        -> refresh, notify, focus
    end note
}

' ==================== SHARED LAYER ====================
package "shared" <<Rectangle>> SHARED_COLOR {
    class Validator {
        + Check(field, condition, message)
        + HasErrors(): bool
    }

    class "ui/DataForm" as SharedDataForm {
        Base form with field errors,
        key captures, help text
    }

    class "dirs" as SharedDirs {
        + ConfigDir(), DataDir()
    }
}

' ==================== CONFIG LAYER ====================
package "config" <<Rectangle>> #FFF3E0 {
    class Config {
        + TagTypes: []TagType
        + TagExcludeWords: []string
        --
        + Load(workdir): *Config
        + Validate(): *Validator
    }
}

' ==================== DATABASE LAYER ====================
package "database" <<Rectangle>> DB_COLOR {
    class DBStore {
        + Connection: *sqlx.DB
        --
        + Setup(path): *DBStore
        + RegisterMigration()
    }

    note as DBNote
        SQLite with:
        - WAL mode
        - Foreign keys enabled
        - Per-domain migrations
    end note
}

' ==================== EXTERNAL ====================
package "External" <<Rectangle>> #F5F5F5 {
    class "tview/tcell" as tview {
        Terminal UI framework
    }

    class "sqlx" as sqlx {
        SQL extensions for Go
    }

    class "modernc/sqlite" as sqlite {
        Pure Go SQLite driver
    }
}

' ==================== RELATIONSHIPS ====================

' Domain internal
Game "1" -- "0..*" Session : has
Character "1" -- "0..*" Attribute : has

GameService --> GameRepository
SessionService --> SessionRepository
TagService --> SessionRepository : reads content
CharacterService --> CharacterRepository
CharacterService --> AttributeService : Duplicate()
AttributeService --> AttributeRepository

GameRepository ..> Game
SessionRepository ..> Session
CharacterRepository ..> Character
AttributeRepository ..> Attribute

' UI Layer
App *-- GameView
App *-- SessionView
App *-- CharacterView
App *-- AttributeView
App *-- TagView
App *-- Notification
App *-- ConfirmationModal
App *-- HelpModal

GameView ..> Event : dispatches
SessionView ..> Event : dispatches
CharacterView ..> Event : dispatches
AttributeView ..> Event : dispatches
TagView ..> Event : dispatches

App ..> Event : handles

GameView --> GameService
GameView --> SessionService
SessionView --> SessionService
CharacterView --> CharacterService
AttributeView --> AttributeService
TagView --> TagService

GameForm ..|> DataForm
SessionForm ..|> DataForm
CharacterForm ..|> DataForm
AttributeForm ..|> DataForm

BaseEvent ..|> Event

' Cross-layer
Game ..> Validator
Session ..> Validator
Character ..> Validator
Attribute ..> Validator
Config ..> TagType

DBStore --> sqlx
App --> tview

' Entry point
note as MainNote
    <b>main.go</b>
    1. config.Load() -> *Config
    2. database.Setup() -> *DBStore
    3. ui.NewApp(db, cfg) -> *App
    4. app.Run() -> event loop
end note

MainNote .. App

@enduml
